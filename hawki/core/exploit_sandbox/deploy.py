#!/usr/bin/env python3
# --------------------
# File: hawki/core/exploit_sandbox/deploy.py
# --------------------
"""
Deploys all Solidity contracts in /repo using solcx and web3.
Saves addresses to /output/addresses.json.
"""

import json
import logging
import os
import glob
import sys
from pathlib import Path

from solcx import compile_files, install_solc, set_solc_version
from web3 import Web3
from web3.middleware import geth_poa_middleware

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("deploy")

def main():
    # Connect to local blockchain (anvil/hardhat)
    w3 = Web3(Web3.HTTPProvider("http://localhost:8545"))
    w3.middleware_onion.inject(geth_poa_middleware, layer=0)
    if not w3.is_connected():
        logger.error("Failed to connect to blockchain")
        sys.exit(1)

    deployer = w3.eth.accounts[0]
    logger.info(f"Deployer: {deployer}")

    # Install solc (use latest 0.8.x)
    solc_version = "0.8.24"
    try:
        install_solc(solc_version)
        set_solc_version(solc_version)
    except Exception as e:
        logger.error(f"Failed to install solc: {e}")
        sys.exit(1)

    # Find all .sol files in /repo
    sol_files = glob.glob("/repo/**/*.sol", recursive=True)
    if not sol_files:
        logger.error("No Solidity files found in /repo")
        sys.exit(1)

    logger.info(f"Found {len(sol_files)} Solidity files")
    # Compile
    compiled = compile_files(sol_files, output_values=["abi", "bin"])
    logger.info(f"Compiled {len(compiled)} contracts")

    addresses = {}
    for contract_name, data in compiled.items():
        if not data["bin"]:
            logger.warning(f"Contract {contract_name} has no bytecode (maybe interface/abstract)")
            continue
        abi = data["abi"]
        bytecode = data["bin"]

        # Deploy
        Contract = w3.eth.contract(abi=abi, bytecode=bytecode)
        tx_hash = Contract.constructor().transact({"from": deployer})
        tx_receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
        address = tx_receipt.contractAddress
        logger.info(f"Deployed {contract_name} at {address}")
        # Use simple name (without path)
        simple_name = contract_name.split(':')[-1] if ':' in contract_name else contract_name
        addresses[simple_name] = address

    # Save addresses
    output_dir = Path("/output")
    output_dir.mkdir(exist_ok=True)
    with open(output_dir / "addresses.json", "w") as f:
        json.dump(addresses, f, indent=2)
    logger.info(f"Addresses saved to {output_dir / 'addresses.json'}")

if __name__ == "__main__":
    main()