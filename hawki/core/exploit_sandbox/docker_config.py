# --------------------
# File: hawki/core/exploit_sandbox/docker_config.py
# --------------------
"""
Docker image management for the exploit sandbox.
Builds and provides the sandbox image.
"""

import logging
import docker
from docker.errors import DockerException, BuildError
from pathlib import Path

logger = logging.getLogger(__name__)

class DockerConfig:
    """Handles Docker image existence and building."""

    IMAGE_NAME = "hawki-sandbox:latest"
    DOCKERFILE_DIR = Path(__file__).parent.parent.parent.parent / "docker"

    def __init__(self):
        self.client = docker.from_env()
        self._ensure_image()

    def _ensure_image(self) -> None:
        """Check if image exists; if not, build it."""
        try:
            self.client.images.get(self.IMAGE_NAME)
            logger.debug(f"Image {self.IMAGE_NAME} found")
        except docker.errors.ImageNotFound:
            logger.info(f"Image {self.IMAGE_NAME} not found, building...")
            self._build_image()
        except DockerException as e:
            logger.error(f"Docker error: {e}")
            raise

    def _build_image(self) -> None:
        """Build the sandbox Docker image."""
        dockerfile_path = self.DOCKERFILE_DIR / "Dockerfile"
        if not dockerfile_path.exists():
            # Create Dockerfile if it doesn't exist
            self.DOCKERFILE_DIR.mkdir(parents=True, exist_ok=True)
            with open(dockerfile_path, "w") as f:
                f.write("""FROM python:3.11-slim

RUN apt-get update && apt-get install -y --no-install-recommends \\
    build-essential \\
    && rm -rf /var/lib/apt/lists/*

RUN pip install --no-cache-dir web3 py-solc-x

WORKDIR /workspace
""")
            logger.info(f"Created Dockerfile at {dockerfile_path}")

        try:
            image, logs = self.client.images.build(
                path=str(self.DOCKERFILE_DIR),
                tag=self.IMAGE_NAME,
                rm=True,
            )
            for log in logs:
                if "stream" in log:
                    logger.debug(log["stream"].strip())
            logger.info(f"Image {self.IMAGE_NAME} built successfully")
        except BuildError as e:
            logger.error(f"Failed to build image: {e}")
            raise
        except Exception as e:
            logger.error(f"Unexpected error during build: {e}")
            raise

# EOF: hawki/core/exploit_sandbox/docker_config.py